@model List<Product>
@{
    ViewData["Title"] = "Trang chủ";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                @TempData["SuccessMessage"]
            </div>
        </div>
    </div>
}

<!-- Carousel Banner -->
<div id="heroCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img src="https://images.unsplash.com/photo-1445205170230-053b83016050?w=1400" class="d-block w-100" alt="Collection 1">
            <div class="carousel-caption d-none d-md-block">
                <h2 class="display-4 fw-bold mb-3">Bộ Sưu Tập Mùa Xuân 2025</h2>
                <p class="lead">Khám phá những xu hướng thời trang mới nhất</p>
                <a asp-controller="Products" asp-action="Index" class="btn btn-light btn-lg mt-2">Mua ngay</a>
            </div>
        </div>
        <div class="carousel-item">
            <img src="https://images.unsplash.com/photo-1490481651871-ab68de25d43d?w=1400" class="d-block w-100" alt="Collection 2">
            <div class="carousel-caption d-none d-md-block">
                <h2 class="display-4 fw-bold mb-3">Giảm Giá Lên Đến 50%</h2>
                <p class="lead">Ưu đãi đặc biệt cho khách hàng mới</p>
                <a asp-controller="Products" asp-action="Index" class="btn btn-light btn-lg mt-2">Khám phá</a>
            </div>
        </div>
        <div class="carousel-item">
            <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=1400" class="d-block w-100" alt="Collection 3">
            <div class="carousel-caption d-none d-md-block">
                <h2 class="display-4 fw-bold mb-3">Thời Trang Cho Mọi Dịp</h2>
                <p class="lead">Bộ sưu tập đa dạng, phong phú</p>
                <a asp-controller="Products" asp-action="Index" class="btn btn-light btn-lg mt-2">Xem thêm</a>
            </div>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>

<div class="container">
    <!-- Dynamic Categories -->
    <h3 class="text-center mb-4 fw-bold"><i class="bi bi-star text-warning"></i> Danh Mục Nổi Bật</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
        @if (ViewBag.Categories != null)
        {
            var categories = ViewBag.Categories as List<Category>;
            foreach (var cat in categories!.Take(8))
            {
                <div class="col">
                    <div class="card product-card border-0 h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-between">
                            <div>
                                <h5 class="card-title fw-bold mb-2">@cat.CategoryName</h5>
                                <p class="text-muted small">@(!string.IsNullOrEmpty(cat.Description) ? cat.Description : "Khám phá các sản phẩm trong danh mục này")</p>
                            </div>
                            <a asp-controller="Products"
                               asp-action="Index"
                               asp-route-categoryId="@cat.CategoryID"
                               class="btn btn-outline-primary mt-2">
                                Xem @cat.CategoryName
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">Chưa có danh mục nào.</p>
        }
    </div>

    @{
        var newest = Model
            .OrderByDescending(p => p.CreatedAt)
            .Take(4)
            .ToList();
        var featured = Model
            .OrderByDescending(p => p.Stock > 0)
            .ThenBy(p => p.Price)
            .Take(8)
            .ToList();
    }

    <!-- Newest Products -->
    <h3 class="text-center mb-4 fw-bold"><i class="bi bi-clock-history text-primary"></i> Sản Phẩm Mới</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
        @foreach (var product in newest)
        {
            <div class="col">
                <div class="card product-card border-0 h-100">
                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product.ProductID" class="text-decoration-none text-dark">
                        <img src="@product.ImageURL" class="card-img-top" style="height: 250px; object-fit: cover;" alt="@product.ProductName" onerror="this.src='https://via.placeholder.com/300x300'">
                    </a>
                    <div class="card-body text-center">
                        <span class="badge bg-primary mb-2">Mới</span>
                        <h6 class="card-title fw-bold">@product.ProductName</h6>
                        <p class="text-danger fw-bold fs-5 mb-2">@product.Price.ToString("N0") ₫</p>
                    </div>
                    <div class="card-footer bg-white border-0">
                        @if (ViewBag.IsAuthenticated != null && (bool)ViewBag.IsAuthenticated)
                        {
                            <button class="btn btn-primary w-100 add-to-cart-btn" data-product-id="@product.ProductID" data-quantity="1">
                                <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                            </button>
                        }
                        else
                        {
                            <a class="btn btn-primary w-100" href="@Url.Action("Login", "Auth")">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để mua
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Featured / Recommended Products -->
    <h3 class="text-center mb-4 fw-bold"><i class="bi bi-heart-fill text-danger"></i> Gợi Ý Cho Bạn</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
        @foreach (var product in featured)
        {
            <div class="col">
                <div class="card product-card border-0 h-100">
                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product.ProductID" class="text-decoration-none text-dark">
                        <img src="@product.ImageURL" class="card-img-top" style="height: 250px; object-fit: cover;" alt="@product.ProductName" onerror="this.src='https://via.placeholder.com/300x300'">
                    </a>
                    <div class="card-body text-center">
                        <h6 class="card-title fw-bold">@product.ProductName</h6>
                        <p class="text-danger fw-bold fs-5 mb-2">@product.Price.ToString("N0") ₫</p>
                        @if (product.Stock > 0)
                        {
                            <span class="badge bg-success">Còn hàng</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Hết hàng</span>
                        }
                    </div>
                    <div class="card-footer bg-white border-0">
                        @if (ViewBag.IsAuthenticated != null && (bool)ViewBag.IsAuthenticated)
                        {
                            <button class="btn btn-outline-primary w-100 add-to-cart-btn" data-product-id="@product.ProductID" data-quantity="1">
                                <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                            </button>
                        }
                        else
                        {
                            <a class="btn btn-outline-primary w-100" href="@Url.Action("Login", "Auth")">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để mua
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
// Show toast notification if exists
document.addEventListener('DOMContentLoaded', function() {
    const toastElement = document.getElementById('successToast');
    if (toastElement) {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }
    
    // Attach event listeners to all add-to-cart buttons
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-product-id'));
            const quantity = parseInt(this.getAttribute('data-quantity')) || 1;
            addToCart(productId, quantity);
        });
    });
});

function addToCart(productId, quantity) {
    console.log('Adding to cart - ProductId:', productId, 'Quantity:', quantity);
    fetch('@Url.Action("Add", "Cart")', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ productId, quantity })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
        .then(data => {
            console.log('Response data:', data);
            if(data.success) {
                showToast('success', 'Đã thêm vào giỏ hàng!');
                updateCartBadge();
            } else {
                showToast('danger', 'Lỗi khi thêm sản phẩm vào giỏ hàng!');
            }
        })
    .catch(error => {
        console.error('Error:', error);
        showToast('danger', 'Có lỗi xảy ra! Vui lòng thử lại.');
    });
}

function showToast(type, message) {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = 9999;
    
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.innerHTML = toastHtml;
    document.body.appendChild(toastContainer);
    
    const toastElement = toastContainer.querySelector('.toast');
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastContainer.remove();
    });
}
</script>
}